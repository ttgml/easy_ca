{% extends "base.html" %}

{% block title %}{{ ca.name }} - CA详情 - Easy CA{% endblock %}

{% block content %}
    <div class="ca-detail max-w-4xl mx-auto">
        <!-- Flash消息 -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="mb-4 p-4 rounded-lg {% if category == 'success' %}bg-green-100 text-green-800 border border-green-200{% elif category == 'danger' %}bg-red-100 text-red-800 border border-red-200{% elif category == 'warning' %}bg-yellow-100 text-yellow-800 border border-yellow-200{% else %}bg-blue-100 text-blue-800 border border-blue-200{% endif %}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        <!-- 状态横幅 -->
        {% if ca.status == 'active' %}
            <div class="bg-green-100 border-l-4 border-green-500 p-4 mb-6">
                <div class="flex items-center">
                    <i class="fas fa-check-circle text-green-600 text-xl mr-3"></i>
                    <div>
                        <p class="font-medium text-green-800">CA处于活跃状态</p>
                        <p class="text-green-700">此CA当前处于活跃状态，可以用于签发证书。</p>
                    </div>
                </div>
            </div>
        {% elif ca.status == 'revoked' %}
            <div class="bg-red-100 border-l-4 border-red-500 p-4 mb-6">
                <div class="flex items-center">
                    <i class="fas fa-times-circle text-red-600 text-xl mr-3"></i>
                    <div>
                        <p class="font-medium text-red-800">CA已吊销</p>
                        <p class="text-red-700">此CA已被吊销，吊销原因：{{ ca.revocation_reason }}</p>
                    </div>
                </div>
            </div>
        {% endif %}
        
        <div class="mb-6">
            <h2 class="text-2xl font-bold text-gray-800">{{ ca.name }}</h2>
            <p class="text-gray-600">CA详情</p>
        </div>
        
        <!-- 基本信息卡片 -->
        <div class="bg-white rounded-lg shadow mb-6">
            <div class="border-b border-gray-200 p-6">
                <h3 class="text-lg font-semibold">基本信息</h3>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="text-sm font-medium text-gray-500 mb-2">名称</h4>
                        <p class="font-medium">{{ ca.name }}</p>
                    </div>
                    <div>
                        <h4 class="text-sm font-medium text-gray-500 mb-2">通用名称 (CN)</h4>
                        <p class="font-medium">{{ ca.common_name }}</p>
                    </div>
                    <div>
                        <h4 class="text-sm font-medium text-gray-500 mb-2">组织名称 (O)</h4>
                        <p class="font-medium">{{ ca.organization or '未设置' }}</p>
                    </div>
                    <div>
                        <h4 class="text-sm font-medium text-gray-500 mb-2">组织单位 (OU)</h4>
                        <p class="font-medium">{{ ca.organizational_unit or 'N/A' }}</p>
                    </div>
                    <div>
                        <h4 class="text-sm font-medium text-gray-500 mb-2">国家 (C)</h4>
                        <p class="font-medium">{{ ca.country or 'N/A' }}</p>
                    </div>
                    <div>
                        <h4 class="text-sm font-medium text-gray-500 mb-2">省/州 (ST)</h4>
                        <p class="font-medium">{{ ca.state or 'N/A' }}</p>
                    </div>
                    <div>
                        <h4 class="text-sm font-medium text-gray-500 mb-2">城市 (L)</h4>
                        <p class="font-medium">{{ ca.locality or 'N/A' }}</p>
                    </div>
                    <div>
                        <h4 class="text-sm font-medium text-gray-500 mb-2">序列号</h4>
                        <p class="font-medium break-all">{{ ca.serial_number }}</p>
                    </div>
                    <div>
                        <h4 class="text-sm font-medium text-gray-500 mb-2">有效期开始</h4>
                        <p class="font-medium">{{ ca.valid_from.strftime('%Y-%m-%d %H:%M:%S') }}</p>
                    </div>
                    <div>
                        <h4 class="text-sm font-medium text-gray-500 mb-2">有效期结束</h4>
                        <p class="font-medium">{{ ca.valid_to.strftime('%Y-%m-%d %H:%M:%S') }}</p>
                    </div>
                    <div>
                        <h4 class="text-sm font-medium text-gray-500 mb-2">创建时间</h4>
                        <p class="font-medium">{{ ca.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</p>
                    </div>
                    {% if ca.status == 'revoked' %}
                    <div>
                        <h4 class="text-sm font-medium text-gray-500 mb-2">吊销时间</h4>
                        <p class="font-medium">{{ ca.revoked_at.strftime('%Y-%m-%d %H:%M:%S') }}</p>
                    </div>
                    <div>
                        <h4 class="text-sm font-medium text-gray-500 mb-2">吊销原因</h4>
                        <p class="font-medium">{{ ca.revocation_reason }}</p>
                    </div>
                    {% endif %}
                    <!-- 父CA信息 -->
                    {% if ca.parent %}
                    <div>
                        <h4 class="text-sm font-medium text-gray-500 mb-2">父CA</h4>
                        <p class="font-medium">
                            <a href="{{ url_for('main.ca_detail', ca_id=ca.parent.id) }}" class="text-blue-600 hover:text-blue-800">
                                {{ ca.parent.name }}
                            </a>
                        </p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- 子CA列表 -->
        {% if ca.children %}
        <div class="bg-white rounded-lg shadow mb-6">
            <div class="border-b border-gray-200 p-6 flex justify-between items-center">
                <h3 class="text-lg font-semibold">子CA</h3>
                <span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-800">{{ ca.children|length }} 个子CA</span>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    {% for child_ca in ca.children %}
                    <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-medium text-gray-900 truncate">{{ child_ca.name }}</h4>
                            {% if child_ca.status == 'active' %}
                                <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">活跃</span>
                            {% elif child_ca.status == 'revoked' %}
                                <span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800">已吊销</span>
                            {% endif %}
                        </div>
                        <p class="text-sm text-gray-500 mb-3">{{ child_ca.common_name }}</p>
                        <a href="{{ url_for('main.ca_detail', ca_id=child_ca.id) }}" 
                           class="text-blue-600 hover:text-blue-800 text-sm font-medium flex items-center">
                            查看详情
                            <i class="fas fa-arrow-right ml-1 text-xs"></i>
                        </a>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- CA证书内容 -->
        <div class="bg-white rounded-lg shadow mb-6">
            <div class="border-b border-gray-200 p-6 flex justify-between items-center">
                <h3 class="text-lg font-semibold">CA证书 (PEM格式)</h3>
                <button class="text-blue-600 hover:text-blue-800 flex items-center" onclick="copyToClipboard('ca-certificate-content')">
                    <i class="fas fa-copy mr-1"></i>复制
                </button>
            </div>
            <div class="p-6 bg-gray-800 text-green-400 overflow-x-auto">
                <pre id="ca-certificate-content" class="text-sm">{{ ca.certificate }}</pre>
            </div>
            <div class="p-6 border-t border-gray-200 flex space-x-3">
                <a href="{{ url_for('main.download_ca_certificate', ca_id=ca.id) }}" 
                   class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors flex items-center">
                    <i class="fas fa-download mr-2"></i>下载CA证书
                </a>
                <a href="{{ url_for('main.download_ca_private_key', ca_id=ca.id) }}" 
                   class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors flex items-center">
                    <i class="fas fa-key mr-2"></i>下载CA私钥
                </a>
            </div>
        </div>
        
        <!-- 由此CA颁发的证书 -->
        <div class="bg-white rounded-lg shadow mb-6">
            <div class="border-b border-gray-200 p-6 flex justify-between items-center">
                <h3 class="text-lg font-semibold">由此CA颁发的证书</h3>
                <span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-800">{{ certificates|length }} 个证书</span>
            </div>
            <div class="p-6">
                {% if certificates %}
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {% for cert in certificates %}
                        <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-medium text-gray-900 truncate">{{ cert.common_name }}</h4>
                                {% if cert.status == 'valid' %}
                                    <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">有效</span>
                                {% elif cert.status == 'expired' %}
                                    <span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-800">已过期</span>
                                {% elif cert.status == 'revoked' %}
                                    <span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800">已吊销</span>
                                {% endif %}
                            </div>
                            <p class="text-sm text-gray-500 mb-3">{{ cert.created_at.strftime('%Y-%m-%d') }}</p>
                            <a href="{{ url_for('main.certificate_detail', cert_id=cert.id) }}" 
                               class="text-blue-600 hover:text-blue-800 text-sm font-medium flex items-center">
                                查看详情
                                <i class="fas fa-arrow-right ml-1 text-xs"></i>
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-8">
                        <i class="fas fa-certificate text-gray-300 text-4xl mb-3"></i>
                        <p class="text-gray-500">此CA尚未颁发任何证书</p>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- 操作区 -->
        <div class="bg-white rounded-lg shadow mb-6">
            <div class="border-b border-gray-200 p-6">
                <h3 class="text-lg font-semibold">操作</h3>
            </div>
            <div class="p-6">
                <div class="flex flex-wrap gap-3">
                    {% if ca.status == 'active' %}
                    <a href="{{ url_for('main.new_certificate', ca_id=ca.id) }}" 
                       class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors flex items-center">
                        <i class="fas fa-plus-circle mr-2"></i>签发新证书
                    </a>
                    <a href="{{ url_for('main.ca_settings', ca_id=ca.id) }}" 
                       class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors flex items-center">
                        <i class="fas fa-cog mr-2"></i>设置
                    </a>
                    <button class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors flex items-center" 
                            onclick="document.getElementById('revoke-ca-modal').classList.remove('hidden')">
                        <i class="fas fa-times-circle mr-2"></i>吊销此CA
                    </button>
                    {% elif ca.status == 'revoked' %}
                    <form action="{{ url_for('main.activate_ca', ca_id=ca.id) }}" method="POST">
                        <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors flex items-center">
                            <i class="fas fa-check-circle mr-2"></i>激活此CA
                        </button>
                    </form>
                    {% endif %}
                    <button class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors flex items-center" 
                            onclick="document.getElementById('delete-ca-modal').classList.remove('hidden')">
                        <i class="fas fa-trash mr-2"></i>删除CA
                    </button>
                    <a href="{{ url_for('main.dashboard') }}" 
                       class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition-colors flex items-center">
                        <i class="fas fa-arrow-left mr-2"></i>返回仪表盘
                    </a>
                </div>
            </div>
        </div>
        
        <!-- ACME快速开始指南 -->
        <div class="bg-white rounded-lg shadow mb-6">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-800">ACME快速开始指南</h3>
                <p class="text-gray-600 mt-1">使用acme.sh客户端配置ACME集成</p>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">ACME目录URL</label>
                    <div class="flex">
                        <input type="text" id="acme_directory_url" 
                               value="{{ request.url_root[:-1] }}{{ url_for('acme.directory', ca_id=ca.id) }}" 
                               readonly 
                               class="flex-1 px-3 py-2 border border-gray-300 rounded-l-md bg-gray-50">
                        <button class="px-4 py-2 bg-gray-200 text-gray-700 rounded-r-md hover:bg-gray-300 transition-colors flex items-center" 
                                onclick="copyToClipboard(document.getElementById('acme_directory_url').value)">
                            <i class="fas fa-copy mr-2"></i>复制
                        </button>
                    </div>
                    <p class="mt-2 text-sm text-gray-500">使用此URL配置您的ACME客户端</p>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">acme.sh 使用示例</label>
                    <div class="bg-gray-50 rounded-md p-4 relative">
                        <button class="absolute top-2 right-2 px-2 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition-colors flex items-center text-sm" 
                                onclick="copyToClipboard(`acme.sh --server {{ request.url_root[:-1] }}{{ url_for('acme.directory', ca_id=ca.id) }} \n        --issue -d example.com -d *.example.com \n        --dns dns_cf`)">
                            <i class="fas fa-copy mr-1"></i>复制
                        </button>
                        <pre class="text-sm text-gray-800"><code>acme.sh --server {{ request.url_root[:-1] }}{{ url_for('acme.directory', ca_id=ca.id) }} 
    --issue -d example.com -d *.example.com 
    --dns dns_cf # 假设使用Cloudflare DNS挑战</code></pre>
                    </div>
                </div>
                
                <div class="text-sm text-gray-600">
                    <p class="mb-2"><strong>参数说明：</strong></p>
                    <ul class="list-disc list-inside space-y-1">
                        <li><code>--server</code>: 指定ACME服务器目录URL</li>
                        <li><code>--issue</code>: 请求签发证书</li>
                        <li><code>-d</code>: 指定要签发证书的域名</li>
                        <li><code>--dns</code>: 指定DNS挑战提供商</li>
                    </ul>
                    <p class="mt-3">了解更多关于 <a href="https://github.com/acmesh-official/acme.sh" target="_blank" class="text-blue-600 hover:underline">acme.sh</a> 的信息</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 吊销CA模态框 -->
    {% if ca.status == 'active' %}
    <div id="revoke-ca-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">吊销CA</h3>
                    <button onclick="document.getElementById('revoke-ca-modal').classList.add('hidden')" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <p class="text-gray-600 mb-4">您确定要吊销此CA吗？此操作将吊销所有由此CA颁发的证书，并且不可撤销。</p>
                <form action="{{ url_for('main.revoke_ca', ca_id=ca.id) }}" method="POST">
                    <div class="mb-4">
                        <label for="revocation_reason" class="block text-sm font-medium text-gray-700 mb-2">吊销原因</label>
                        <select id="revocation_reason" name="revocation_reason" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="Unspecified">未指定</option>
                            <option value="Key Compromise">密钥泄露</option>
                            <option value="CA Compromise">CA泄露</option>
                            <option value="Superseded">证书已被取代</option>
                            <option value="Cessation of Operation">操作终止</option>
                        </select>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="document.getElementById('revoke-ca-modal').classList.add('hidden')" 
                                class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition-colors">
                            取消
                        </button>
                        <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">
                            确认吊销
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- 删除CA模态框 -->
    <div id="delete-ca-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">删除CA</h3>
                    <button onclick="document.getElementById('delete-ca-modal').classList.add('hidden')" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <p class="text-gray-600 mb-4">您确定要删除此CA吗？此操作将永久删除CA及其所有相关信息，并且不可撤销。</p>
                <form action="{{ url_for('main.delete_ca', ca_id=ca.id) }}" method="POST">
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="document.getElementById('delete-ca-modal').classList.add('hidden')" 
                                class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition-colors">
                            取消
                        </button>
                        <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">
                            确认删除
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script>
        // 复制到剪贴板功能已在base.html中定义
        // 这里只需要确保调用时传递正确的参数
    </script>
{% endblock %}