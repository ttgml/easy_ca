{% extends "base.html" %}

{% block title %}新建证书 - Easy CA{% endblock %}

{% block content %}
    <div class="max-w-3xl mx-auto">
        <div class="mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-2">签发新证书</h2>
            <p class="text-gray-600">通过简单的几步流程，为您的域名签发SSL证书</p>
        </div>
        
        <!-- 进度指示器 -->
        <div class="mb-8">
            <div class="flex items-center justify-between relative">
                <!-- 连接线 -->
                <div class="absolute top-4 left-0 right-0 h-0.5 bg-gray-200 -z-10"></div>
                
                <!-- 步骤1 -->
                <div class="flex flex-col items-center w-1/3">
                    <div class="w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center mb-2">1</div>
                    <span class="text-sm font-medium text-gray-900">选择CA</span>
                </div>
                
                <!-- 步骤2 -->
                <div class="flex flex-col items-center w-1/3">
                    <div class="w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center mb-2">2</div>
                    <span class="text-sm font-medium text-gray-900">证书详情</span>
                </div>
                
                <!-- 步骤3 -->
                <div class="flex flex-col items-center w-1/3">
                    <div class="w-8 h-8 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center mb-2">3</div>
                    <span class="text-sm font-medium text-gray-500">确认并生成</span>
                </div>
            </div>
        </div>
        
        <!-- 表单内容 -->
        <div class="bg-white rounded-lg shadow p-6">
            <form method="POST" action="{{ url_for('main.new_certificate') }}">
                <!-- 显示消息 -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="mb-4 p-4 rounded-lg bg-red-50 text-red-800">
                                <i class="fas fa-exclamation-circle mr-2"></i>{{ message }}
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
                
                <!-- 第1步：选择证书颁发机构 -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold mb-4">第1步：选择证书颁发机构</h3>
                    <div class="form-group mb-4">
                        <label for="ca_id" class="block text-sm font-medium text-gray-700 mb-2">选择证书颁发机构</label>
                        <select id="ca_id" name="ca_id" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            {% if cas %}
                                <option value="">请选择一个证书颁发机构</option>
                                {% for ca in cas %}
                                    {% if ca.status == 'active' %}
                                        <option value="{{ ca.id }}" {% if request.args.get('ca_id')|int == ca.id %}selected{% endif %}>{{ ca.name }} ({{ ca.common_name }})</option>
                                    {% endif %}
                                {% endfor %}
                            {% else %}
                                <option value="">无可用证书颁发机构，请先创建CA</option>
                            {% endif %}
                        </select>
                        <p class="mt-2 text-sm text-gray-500">请选择一个状态为"Active"的证书颁发机构来签发证书</p>
                    </div>
                </div>
                
                <!-- 第2步：证书详情 -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold mb-4">第2步：证书详情</h3>
                    
                    <div class="form-group mb-4">
                        <label for="common_name" class="block text-sm font-medium text-gray-700 mb-2">通用名称 (CN)</label>
                        <input type="text" id="common_name" name="common_name" required placeholder="例如：www.example.com" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <p class="mt-2 text-sm text-gray-500">输入您的主域名，例如：www.example.com</p>
                    </div>
                    
                    <div class="form-group mb-4">
                        <label for="sans" class="block text-sm font-medium text-gray-700 mb-2">主题备用名称 (可选)</label>
                        <textarea id="sans" name="sans" rows="4" placeholder="例如：
example.com
api.example.com
*.test.example.com" 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                        <p class="mt-2 text-sm text-gray-500">每行输入一个域名，支持通配符域名（如：*.example.com）</p>
                    </div>
                    
                    <div class="form-group mb-4">
                        <label for="validity_days" class="block text-sm font-medium text-gray-700 mb-2">有效期</label>
                        <select id="validity_days" name="validity_days" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="30">30天</option>
                            <option value="90">90天</option>
                            <option value="180">180天</option>
                            <option value="365" selected>1年</option>
                            <option value="730">2年</option>
                        </select>
                        <p class="mt-2 text-sm text-gray-500">选择证书的有效期</p>
                    </div>
                </div>
                
                <!-- 操作按钮 -->
                <div class="flex justify-between">
                    <a href="{{ url_for('main.dashboard') }}" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition-colors">
                        <i class="fas fa-arrow-left mr-2"></i>返回仪表盘
                    </a>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors flex items-center">
                        <i class="fas fa-certificate mr-2"></i>签发证书
                    </button>
                </div>
            </form>
        </div>
    </div>
{% endblock %}