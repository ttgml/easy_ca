{% extends "base.html" %}

{% block title %}创建新的CA - Easy CA{% endblock %}

{% block content %}
    <div class="new-ca max-w-2xl mx-auto">
        <div class="mb-6">
            <h2 class="text-2xl font-bold text-gray-800">创建新的证书颁发机构 (CA)</h2>
            <p class="text-gray-600">填写以下信息以创建新的根CA</p>
        </div>
        
        <!-- 显示消息 -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        <div class="bg-white rounded-lg shadow">
            <form method="POST" action="{{ url_for('main.new_ca') }}" class="p-6">
                <div class="space-y-6">
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700 mb-1">CA名称 *</label>
                        <input type="text" id="name" name="name" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="例如：我的公司根CA">
                        <p class="mt-1 text-sm text-gray-500">用于标识此CA的名称，例如 "My Company Root CA"</p>
                    </div>
                    
                    <div>
                        <label for="common_name" class="block text-sm font-medium text-gray-700 mb-1">通用名称 (Common Name) *</label>
                        <input type="text" id="common_name" name="common_name" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="例如：mycompany.com">
                        <p class="mt-1 text-sm text-gray-500">CA证书的通用名称，例如 "My Company Root CA"</p>
                    </div>
                    
                    <div>
                        <label for="organization" class="block text-sm font-medium text-gray-700 mb-1">组织名称 (Organization)</label>
                        <input type="text" id="organization" name="organization" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="例如：我的公司名称">
                        <p class="mt-1 text-sm text-gray-500">组织的完整法定名称，例如 "My Company Inc."</p>
                    </div>

                    <!-- CA类型选择 -->
                    <div class="form-group mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">CA类型</label>
                        <div class="flex space-x-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="ca_type" value="root" checked class="form-radio text-blue-600" onchange="toggleParentCASelect()">
                                <span class="ml-2">根CA</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="ca_type" value="intermediate" class="form-radio text-blue-600" onchange="toggleParentCASelect()">
                                <span class="ml-2">中间CA</span>
                            </label>
                        </div>
                    </div>

                    <!-- 父CA选择（仅在创建中间CA时显示） -->
                    <div class="form-group mb-4 hidden" id="parent-ca-select">
                        <label for="parent_ca_id" class="block text-sm font-medium text-gray-700 mb-2">父CA</label>
                        <select id="parent_ca_id" name="parent_ca_id" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">请选择父CA</option>
                            {% for ca in active_cas %}
                                <option value="{{ ca.id }}">{{ ca.name }} ({{ ca.common_name }})</option>
                            {% endfor %}
                        </select>
                        <p class="mt-2 text-sm text-gray-500">选择用于签发此中间CA的父CA</p>
                    </div>
                    
                    <div>
                        <label for="organizational_unit" class="block text-sm font-medium text-gray-700 mb-1">组织单位 (Organizational Unit)</label>
                        <input type="text" id="organizational_unit" name="organizational_unit" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <p class="mt-1 text-sm text-gray-500">可选，例如 "IT Department" 或 "Security Division"</p>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="country" class="block text-sm font-medium text-gray-700 mb-1">国家 (Country)</label>
                            <input type="text" id="country" name="country" maxlength="2" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <p class="mt-1 text-sm text-gray-500">两个字母的国家代码，例如 "US"</p>
                        </div>
                        
                        <div>
                            <label for="state" class="block text-sm font-medium text-gray-700 mb-1">省/州 (State/Province)</label>
                            <input type="text" id="state" name="state" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label for="locality" class="block text-sm font-medium text-gray-700 mb-1">城市 (Locality)</label>
                            <input type="text" id="locality" name="locality" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="validity_years" class="block text-sm font-medium text-gray-700 mb-1">有效期 (年)</label>
                            <select id="validity_years" name="validity_years" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="1">1年</option>
                                <option value="3">3年</option>
                                <option value="5" selected>5年</option>
                                <option value="10">10年</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="key_type" class="block text-sm font-medium text-gray-700 mb-1">密钥类型</label>
                            <select id="key_type" name="key_type" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="RSA" selected>RSA</option>
                                <option value="ECC">ECC</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="key_size" class="block text-sm font-medium text-gray-700 mb-1">密钥大小</label>
                            <select id="key_size" name="key_size" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="2048" selected>2048位 (RSA)</option>
                                <option value="4096">4096位 (RSA)</option>
                                <option value="256">256位 (ECC)</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- 高级选项切换按钮 -->
                    <div class="flex justify-end">
                        <button type="button" id="toggle-advanced-options" 
                                class="text-blue-600 hover:text-blue-800 flex items-center">
                            <i class="fas fa-chevron-down mr-1"></i> 高级选项
                        </button>
                    </div>
                    
                    <!-- 高级选项区域 -->
                    <div id="advanced-options" class="space-y-6 hidden">
                        <div class="border-t border-gray-200 pt-6">
                            <h3 class="text-lg font-medium text-gray-800 mb-4">高级选项</h3>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="hash_algorithm" class="block text-sm font-medium text-gray-700 mb-1">签名散列算法</label>
                                    <select id="hash_algorithm" name="hash_algorithm" 
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="SHA-256" selected>SHA-256</option>
                                        <option value="SHA-384">SHA-384</option>
                                        <option value="SHA-512">SHA-512</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label for="path_length" class="block text-sm font-medium text-gray-700 mb-1">路径长度约束</label>
                                    <input type="number" id="path_length" name="path_length" min="0" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="例如：0">
                                    <p class="mt-1 text-sm text-gray-500">设置CA证书的路径长度约束，0表示不能签发其他CA证书</p>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">密钥用法</label>
                                <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" name="key_usage" value="digital_signature" 
                                               class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                        <span class="ml-2 text-sm text-gray-700">数字签名</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" name="key_usage" value="key_encipherment" 
                                               class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                        <span class="ml-2 text-sm text-gray-700">密钥加密</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" name="key_usage" value="data_encipherment" 
                                               class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                        <span class="ml-2 text-sm text-gray-700">数据加密</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" name="key_usage" value="key_agreement" 
                                               class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                        <span class="ml-2 text-sm text-gray-700">密钥协商</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" name="key_usage" value="key_cert_sign" 
                                               class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                        <span class="ml-2 text-sm text-gray-700">证书签名</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" name="key_usage" value="crl_sign" 
                                               class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                        <span class="ml-2 text-sm text-gray-700">CRL签名</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div>
                                <label for="crl_distribution_points" class="block text-sm font-medium text-gray-700 mb-1">CRL分发点</label>
                                <input type="text" id="crl_distribution_points" name="crl_distribution_points" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="例如：http://crl.mycompany.com/ca.crl">
                                <p class="mt-1 text-sm text-gray-500">指定证书吊销列表(CRL)的分发点URL</p>
                            </div>
                            
                            <div>
                                <label for="authority_info_access" class="block text-sm font-medium text-gray-700 mb-1">权威信息访问</label>
                                <input type="text" id="authority_info_access" name="authority_info_access" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="例如：OCSP;URI:http://ocsp.mycompany.com/">
                                <p class="mt-1 text-sm text-gray-500">指定权威信息访问(AIA)扩展的值</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                        <a href="{{ url_for('main.dashboard') }}" 
                           class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition-colors">
                            取消
                        </a>
                        <button type="submit" 
                                class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors flex items-center">
                            <i class="fas fa-plus-circle mr-2"></i>创建CA
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- JavaScript代码 -->
    <script>
        // 高级选项切换功能
        document.addEventListener('DOMContentLoaded', function() {
            const toggleButton = document.getElementById('toggle-advanced-options');
            const toggleIcon = document.getElementById('toggle-icon');
            const advancedOptions = document.getElementById('advanced-options');
            
            toggleButton.addEventListener('click', function() {
                const isHidden = advancedOptions.classList.contains('hidden');
                
                if (isHidden) {
                    // 显示高级选项
                    advancedOptions.classList.remove('hidden');
                    toggleIcon.style.transform = 'rotate(90deg)';
                    toggleButton.innerHTML = '<i class="fas fa-chevron-down mr-2 transition-transform duration-200" id="toggle-icon" style="transform: rotate(90deg);"></i>隐藏高级选项';
                } else {
                    // 隐藏高级选项
                    advancedOptions.classList.add('hidden');
                    toggleIcon.style.transform = 'rotate(0deg)';
                    toggleButton.innerHTML = '<i class="fas fa-chevron-right mr-2 transition-transform duration-200" id="toggle-icon"></i>显示高级选项';
                }
            });
            
            // 密钥类型切换
            const keyTypeRadios = document.querySelectorAll('input[name="key_type"]');
            const rsaOptions = document.querySelector('.rsa-options');
            const ecdsaOptions = document.querySelector('.ecdsa-options');
            
            keyTypeRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.value === 'RSA') {
                        rsaOptions.classList.remove('hidden');
                        ecdsaOptions.classList.add('hidden');
                    } else {
                        rsaOptions.classList.add('hidden');
                        ecdsaOptions.classList.remove('hidden');
                    }
                });
            });
        });
        
        // CA类型切换功能
        function toggleParentCASelect() {
            const caType = document.querySelector('input[name="ca_type"]:checked').value;
            const parentCASelect = document.getElementById('parent-ca-select');
            
            if (caType === 'intermediate') {
                parentCASelect.classList.remove('hidden');
            } else {
                parentCASelect.classList.add('hidden');
            }
        }
    </script>
{% endblock %}